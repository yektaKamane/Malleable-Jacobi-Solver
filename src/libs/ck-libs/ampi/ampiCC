#!/bin/sh
CHARMBIN=`dirname $0`

[ -z "$AMPICC_MODE" ] && AMPICC_MODE='ampi'
STANDALONE=''
ROMIO_CONFIGURE=''
MPITEST=''

ARGS=''

processArgs() {
while [ ! $# -eq 0 ]
do
  arg="$1"
  case "$arg" in
  -show)
     echo "charmc"
     exit 0
     ;;
  -standalone)
     STANDALONE='true'
     ;;

  # These arguments manage compilation of ROMIO's configure tests.
  # Simple environment tests will be compiled as standalone binaries,
  # while MPI tests will be compiled with AMPI.
  -ampi-romio-configure) # Strictly for internal use.
     ROMIO_CONFIGURE='true'
     ;;
  mpitest*) # mpitest.c, mpitest1.c, mpitest.f, etc
     ARGS="$ARGS \"$arg\""
     MPITEST='true'
     ;;

  *)
     ARGS="$ARGS \"$arg\""
     ;;
  esac
  shift
done
}

eval processArgs "$@"

[ -n "$ROMIO_CONFIGURE" -a -z "$MPITEST" ] && STANDALONE='true'

[ -n "$STANDALONE" ] && ARGS="$ARGS -standalone"

[ -f $CHARMBIN/../lib/libampiromio.a -a -z "$STANDALONE" -a -z "$ROMIO_CONFIGURE" ] && ROMIO='-lampiromio'

$CHARMBIN/charmc -language $AMPICC_MODE -default-to-aout $ARGS $ROMIO
status=$?

# Copy ampirun, but do not overwrite it if it already exists.
[ $status -eq 0 ] && cp -n $CHARMBIN/ampirun .

exit $status
