# Makefile included by each manual: contains the 
#   common build commands/targets ("make pdf", "make ps", "make html")
#   common "upload-to-web" targets ("make web")

# The enclosing Makefile is expected to set the variables:
#   FILE: base name of master TeX file (typically "manual")
#   TEX: all TeX files to depend on (often just "manual.tex")
#   DEST: destination manual name (e.g., "fem")
#   LATEX2HTML: call to latex2html, which should be "$(L2H) <args>"
# (optional) PROJECT_LINK: HTML to include at bottom of page

# Destination directory for local copy of files (e.g., on user machine)
DOCDIR=..

# Destination directory for web-accessible copy of files (e.g., on PPL machines)
WEBDIR=/www/ppl_manuals

# Call to Latex2html
L2H=latex2html -white -antialias -local_icons \
	-long_titles 1 \
	-show_section_numbers \
	-top_navigation \
	-address '<p align="right">'"`/bin/date +"%B %d, %Y"`"'<br> \
            '$(PROJECT_LINK)'<a href="http://charm.cs.uiuc.edu/">Charm Homepage</a>'

DEPTEX=$(TEX) $(FILE).aux index.tex

# Default target: build postscript, pdf, and html:

all: pdf ps html

# PostScript Target:
ps: $(FILE).ps

# latex does not create dvi anymore on new linux distributions
#$(FILE).dvi: $(TEX) $(FILE).aux 
#	latex $(FILE).tex

$(FILE).ps: $(FILE).pdf
	pdftops -level1 -paper letter $(FILE).pdf $(FILE).ps
	#dvips -t letter -f $(FILE).dvi > $(FILE).ps


# PDF Target:
pdf: $(FILE).pdf

$(FILE).pdf: $(TEX) $(FILE).aux
	pdflatex $(FILE).tex
	pdflatex $(FILE).tex

# HTML Target:
html: $(FILE)

$(FILE): $(TEX) $(FILE).aux
	-@ln -s ../pplmanual.* .
	-@ln -s ../dot.latex2html-init .latex2html-init
	-@rm -fr $(FILE)/*.html $(FILE)/*.aux
	-@mkdir $(FILE)
	-@ln -s ../../manual.css $(FILE)
	-/bin/cp title.html $(FILE)
	$(L2H) -split 0 $(FILE).tex
	-@mv $(FILE)/$(FILE).html $(FILE)/$(FILE)-1p.html
	$(LATEX2HTML) $(FILE).tex
	../latex2html_fixpaths.sh

# LaTeX Index and link support
$(FILE).aux: $(TEX) index.tex $(FIG_TARGET)
	latex $(FILE).tex

index.tex: $(FILE).idx
	makeindex -o index.tex $(FILE).idx

$(FILE).idx:
	touch $(FILE).idx

# Clean out all TeX droppings:
clean:
	-rm -fr *.aux *.log *.dvi *.ps *.pdf *.out *.ilg $(FILE)
	-rm -fr *.idx *.log *.bbl *.blg *.toc *~ fig/*.bak
	-rm -fr index.tex $(FIG_CLEAN)

# Build local copy of documentation:
doc: all
	if [ ! -d $(DOCDIR) ] ; then mkdir $(DOCDIR) ; fi
	if [ ! -d $(DOCDIR)/ps ] ; then mkdir $(DOCDIR)/ps ; fi
	if [ ! -d $(DOCDIR)/pdf ] ; then mkdir $(DOCDIR)/pdf ; fi
	if [ ! -d $(DOCDIR)/html ] ; then mkdir $(DOCDIR)/html ; fi
	/bin/cp $(FILE).ps $(DOCDIR)/ps/$(DEST).ps
	chmod 664 $(DOCDIR)/ps/$(DEST).ps
	/bin/cp $(FILE).pdf $(DOCDIR)/pdf/$(DEST).pdf
	chmod 664 $(DOCDIR)/pdf/$(DEST).pdf
	/bin/rm -rf $(DOCDIR)/html/$(DEST)
	/bin/cp -R $(FILE) $(DOCDIR)/html/$(DEST)
	find $(DOCDIR)/html/$(DEST) $(DOCDIR)/p*/$(DEST).p* -type f -exec chmod 664 {} \;
	find $(DOCDIR)/html/$(DEST) -type d -exec chmod 775 {} \;

# Build web copy of documentation (PPL-only):
web: all
	/bin/cp $(FILE).ps $(WEBDIR)/ps/$(DEST).ps
	-chmod 664 $(WEBDIR)/ps/$(DEST).ps
	/bin/cp $(FILE).pdf $(WEBDIR)/pdf/$(DEST).pdf
	-chmod 664 $(WEBDIR)/pdf/$(DEST).pdf
	/bin/rm -rf $(WEBDIR)/html/$(DEST)
	/bin/cp -R $(FILE) $(WEBDIR)/html/$(DEST)
	find $(WEBDIR)/html/$(DEST) $(WEBDIR)/p*/$(DEST).p* -type f -exec chmod 664 {} \;
	find $(WEBDIR)/html/$(DEST) -type d -exec chmod 775 {} \;
	-chgrp -R kale $(WEBDIR)/html/$(DEST) $(WEBDIR)/p*/$(DEST).p*

